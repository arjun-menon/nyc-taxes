<!DOCTYPE html>
<html lang="en">

<head>
    <title>Taxes in NYC</title>

    <link rel="stylesheet" href="style.css">

    <!-- GitHub Ribbon: https://github.com/simonwhitaker/github-fork-ribbon-css -->
    <link rel="stylesheet" href="gh-fork-ribbon.css">
    <!--[if lt IE 9]>
        <link rel="stylesheet" href="gh-fork-ribbon.ie.css">
    <![endif]-->
    <!-- GitHub Ribbon -->
</head>

<body>

<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
        <a href="https://github.com/novarc/taxes-in-nyc">Contribute on GitHub</a>
    </div>
</div>

<div class="github-fork-ribbon-wrapper left">
    <div class="github-fork-ribbon">
        <a href="https://novarc.org">By Arjun G. Menon</a>
    </div>
</div>

<h1>Taxes in NYC</h1>

<div class="purpose">Calculate total U.S. taxes owed by an unmarried resident of NYC in 2014</div>

<form id="input_form" method="get">
<fieldset>
    <legend>&#10003;</legend>

    <label for="agi">Your Adjusted Gross Income:</label>
    $ <input id="agi" name="income" type="text" size="20" value="" /><br />

    <label for="itd">Your Itemized Tax Deductions: </label>
    $ <input id="itd" name="deductions" type="text" size="20" value="0" /><br />

    <label for="npe">Number of Personal Exemptions: </label>
    $ <input id="npe" name="exemptions" type="text" size="20" value="1" /><br />

    <input id="calc_submit" type="submit" value="Calculate" />
</fieldset>
</form>

<br />

<div id="results"></div>

<br />

<script src="nyc_taxes.js" text="text/javascript"></script>

<script text="text/javascript">

function getParameterByName(name) {
    // from: http://stackoverflow.com/a/901144/908430
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function createHtmlFragment(htmlStr) {
    // from: http://stackoverflow.com/a/814649/908430
    // also, see: http://ejohn.org/blog/dom-documentfragments/
    var frag = document.createDocumentFragment(),
        temp = document.createElement('div');
    temp.innerHTML = htmlStr;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    return frag;
}

function setResults(htmlStr) {
    var results = document.getElementById('results')
    results.innerHTML = ""

    var fragment = createHtmlFragment(htmlStr);
    results.appendChild(fragment);

    if(htmlStr != "")
        results.style.visibility = 'visible';
    else
        results.style.visibility = 'hidden';
}

function calculateAndDisplayTaxes(income, deductions, exemptions) {
    var resultsHtml = ""

    function w(kind, text, amt) {
        if ( kind == 'a' )
            resultsHtml += '<p>' + text + ': ' + amt + '</p>'
        else if ( kind == 'l_start' )
            resultsHtml += '<div class="seclist"><p><strong>' + text + '</strong><ul>'
        else if ( kind == 'b' )
            resultsHtml += '<li>' + text + '</li>'
        else if ( kind == 'l_end' )
            resultsHtml += '</ul><em>' + text + ':</em> ' + amt + '</p></div>'
        else if ( kind == 't' )
            resultsHtml += '<p>' + text + '</p>'
        else if ( kind == 'x' ) // html decorators
            resultsHtml += text
    }

    function do_nothing_w(kind, text, amt) {
    }

    var my_tax      = calc_taxes(income,       deductions, exemptions, w),
        my_tax_plus = calc_taxes(income + 1.0, deductions, exemptions, do_nothing_w)

    var marginal_tax_rate = (my_tax_plus - my_tax) * 100.0
    w('a', "Marginal Tax Rate", marginal_tax_rate.toFixed(2) + '%')

    return resultsHtml
}

function calcAndDisplay(input) {
    setResults( calculateAndDisplayTaxes(input.income, input.deductions, input.exemptions) )
}

function constructErrorMessage(input, incomeParam, deductionsParam, exemptionsParam) {
    var errorMessage = ""

    if( (incomeParam != '') && !(input.income >= 0) )
        errorMessage += "Income: '" + incomeParam + "'" + " is not valid. <br />"
    if( (deductionsParam != '') && !(input.deductions >= 0) )
        errorMessage += "Deductions: '" + deductionsParam + "'" + " is not valid. <br />"
    if( (exemptionsParam != '') && !(input.exemptions >= 0) )
        errorMessage += "Exemptions: '" + exemptionsParam + "'" + " is not valid. <br />"    

    return errorMessage
}

function createInputObject(incomeParam, deductionsParam, exemptionsParam) {
    var input = {
        income : parseFloat(incomeParam), 
        deductions : parseFloat(deductionsParam), 
        exemptions : parseFloat(exemptionsParam)
    }

    if(input.income > 0 && input.deductions >= 0 && input.exemptions >= 0)
        return input
    else
        throw constructErrorMessage(input, incomeParam, deductionsParam, exemptionsParam)
}

function setFormValues(incomeVal, deductionsVal, exemptionsVal) {
    document.getElementById('agi').value = incomeVal
    document.getElementById('itd').value = deductionsVal
    document.getElementById('npe').value = exemptionsVal
}

function getParams() {
    var incomeParam = getParameterByName('income');
    var deductionsParam = getParameterByName('deductions');
    var exemptionsParam = getParameterByName('exemptions');

    if(deductionsParam == "")
        deductionsParam = '0'

    if(exemptionsParam == "")
        exemptionsParam = '1'

    setFormValues(incomeParam, deductionsParam, exemptionsParam)

    return createInputObject(incomeParam, deductionsParam, exemptionsParam)
}

function getFormParams() {
    return {
        income : document.getElementById('agi').value, 
        deductions : document.getElementById('itd').value, 
        exemptions : document.getElementById('npe').value
    }
}

function createInputObjectFromParams(formParams) {
    return createInputObject(formParams.income, formParams.deductions, formParams.exemptions)
}

function overrideSubmit(onsubmit_function) {
    // from: http://stackoverflow.com/a/1395254
    // also see: http://stackoverflow.com/a/3350260
    function jsSubmit() {
        onsubmit_function()
        return false
    }
    document.forms['input_form'].onsubmit = jsSubmit;
}

function doesSupportHistoryAPI() {
    // from: http://stackoverflow.com/a/9446306
    return !!(window.history && history.pushState);
}

function encodeQueryData(data) {
    // from: http://stackoverflow.com/a/111545
    var ret = [];
    for (var d in data)
        ret.push(encodeURIComponent(d) + "=" + encodeURIComponent(data[d]));
    return ret.join("&");
}

function dynamicSubmit() {
    var formParams = getFormParams()

    try {
        var input = createInputObjectFromParams(formParams)

        history.pushState(formParams, "", "?" + encodeQueryData(formParams));

        calcAndDisplay(input)
    }
    catch(err_output) {
        history.pushState(formParams, "", "?" + encodeQueryData(formParams));

        setResults(err_output)
    }
}

function main() {
    try {
        var input = getParams()

        calcAndDisplay(input)
    }
    catch(err_output) {
        setResults(err_output)
        var input = null
    }

    if ( doesSupportHistoryAPI() ) {
        overrideSubmit(dynamicSubmit)

        window.onpopstate = function(event) {
            var formParams = event.state

            if(formParams)
                setFormValues(formParams.income, formParams.deductions, formParams.exemptions)

            try {
                var input = formParams ? createInputObjectFromParams(formParams) : getParams()

                calcAndDisplay(input)
            }
            catch(err_output) {
                setResults(err_output)
            }
        }
    }
}

main()

</script>

</body>

</html>
