<!DOCTYPE html>
<html lang="en">

<head>
    <title>Taxes in NYC</title>

    <link rel="stylesheet" href="style.css">

    <!-- GitHub Ribbon: https://github.com/simonwhitaker/github-fork-ribbon-css -->
    <link rel="stylesheet" href="gh-fork-ribbon.css">
    <!--[if lt IE 9]>
        <link rel="stylesheet" href="gh-fork-ribbon.ie.css">
    <![endif]-->
    <!-- GitHub Ribbon -->
</head>

<body>

<div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
        <a href="https://github.com/arjungmenon/nyc-tax-calculator">Contribute on GitHub</a>
    </div>
</div>

<div class="github-fork-ribbon-wrapper left">
    <div class="github-fork-ribbon">
        <a href="http://www.arjungmenon.com/">By Arjun G. Menon</a>
    </div>
</div>

<h1>Taxes in NYC</h1>

<div class="purpose">Calculate total U.S. taxes owed by an unmarried resident of NYC in 2014</div>

<form method="get">
<fieldset>
    <legend>&#10003;</legend>

    <label for="agi">Your Adjusted Gross Income:</label>
    $<input id="agi" name="income" type="text" size="20" value="" /><br />

    <label for="itd">Your Itemized Tax Deductions: </label>
    $<input id="itd" name="deductions" type="text" size="20" value="0" /><br />

    <label for="npe">Number of Personal Exemptions: </label>
    $<input id="npe" name="exemptions" type="text" size="20" value="1" /><br />

    <input id="calc_submit" type="submit" value="Calculate" />

</fieldset>
</form>

<br />

<div id="results"></div>

<br />

<script src="nyc_taxes.js" text="text/javascript"></script>

<script text="text/javascript">

function getParameterByName(name) {
    // from: http://stackoverflow.com/a/901144/908430
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function createHtmlFragment(htmlStr) {
    // from: http://stackoverflow.com/a/814649/908430
    // also, see: http://ejohn.org/blog/dom-documentfragments/
    var frag = document.createDocumentFragment(),
        temp = document.createElement('div');
    temp.innerHTML = htmlStr;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    return frag;
}

function setResults(htmlStr) {
    var results = document.getElementById('results')
    results.innerHTML = ""

    var fragment = createHtmlFragment(htmlStr);
    results.insertBefore(fragment);

    results.style.visibility = 'visible';
}

function calculateAndDisplayTaxes(income, deductions, exemptions) {
    resultsHtml = ""

    function w(kind, text, amt) {
        if ( kind == 'a' )
            resultsHtml += '<p>' + text + ': ' + amt + '</p>'
        else if ( kind == 'l_start' )
            resultsHtml += '<div class="seclist"><p><strong>' + text + '</strong><ul>'
        else if ( kind == 'b' )
            resultsHtml += '<li>' + text + '</li>'
        else if ( kind == 'l_end' )
            resultsHtml += '</ul><em>' + text + ':</em> ' + amt + '</p></div>'
        else if ( kind == 't' )
            resultsHtml += '<p>' + text + '</p>'
        else if ( kind == 'x' ) // html decorators
            resultsHtml += text
    }

    function do_nothing_w(kind, text, amt) {
    }

    my_tax = calc_taxes(income, deductions, exemptions, w)

    my_tax_extra = calc_taxes(income + 1.0, deductions, exemptions, do_nothing_w)
    marginal_tax_rate = (my_tax_extra - my_tax) * 100.0
    w('a', "Marginal Tax Rate", marginal_tax_rate.toFixed(2) + '%')

    setResults(resultsHtml)
}

var incomeParam = getParameterByName('income');
var deductionsParam = getParameterByName('deductions');
var exemptionsParam = getParameterByName('exemptions');

if(deductionsParam == "")
    deductionsParam = '0'

if(exemptionsParam == "")
    exemptionsParam = '1'

income = parseInt(incomeParam)
deductions = parseInt(deductionsParam)
exemptions = parseInt(exemptionsParam)

document.getElementById('agi').value = incomeParam
document.getElementById('itd').value = deductionsParam
document.getElementById('npe').value = exemptionsParam

if(income > 0 && deductions >= 0 && exemptions >= 0) {
    calculateAndDisplayTaxes(income, deductions, exemptions)
}
else {
    err_output = ""
    if( (incomeParam != '') && !(income >= 0) || (income < 0) )
        err_output += "Income: '" + incomeParam + "'" + " is not valid. <br />"
    if( (deductionsParam != '') && !(deductions >= 0) )
        err_output += "Deductions: '" + deductionsParam + "'" + " is not valid. <br />"
    if( (exemptionsParam != '') && !(exemptions >= 0) )
        err_output += "Exemptions: '" + exemptionsParam + "'" + " is not valid. <br />"

    if (err_output != "")
        setResults(err_output)
}

</script>

</body>

</html>
